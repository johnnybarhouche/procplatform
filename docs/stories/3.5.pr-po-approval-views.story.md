# Story 3.5: PR/PO Approval Views

## Status
Done

## Story
**As a** project approver,
**I want** consolidated PR and PO approval views that surface all required context and actions,
**so that** I can complete gated approvals confidently while maintaining audit-ready records.

## Acceptance Criteria
1. Render the PR approval view using the specified card layout: header with project, supplier, PR number, and dual AED/USD totals, plus traceability chips linking upstream MR/RFQ context. [Source: docs/front-end.md#34-purchase-requisition-pr; docs/uiux/ui-audit-report.md#24-purchase-requisition-pr]
2. Display the multi-step approval matrix driven by thresholds, showing completed, current, and upcoming approvers with role/limit details and pending indicators. [Source: docs/architecture/workflow-handling.md#workflow-handling; docs/front-end.md#34-purchase-requisition-pr]
3. Provide Approve/Reject/Comment actions that respect workflow gating, capture comments, update audit logs, and reflect status history without allowing bypass of mandatory steps. [Source: docs/prd/user-flows.md#54-purchase-requisition-pr; docs/architecture/cross-cutting-concerns.md#cross-cutting-concerns]
4. Include a PO timeline widget that visualizes Draft → Approved → Sent → Acknowledged states, synchronizes with workflow status, and surfaces dispatch actions (PDF send, acknowledgements). [Source: docs/front-end.md#35-purchase-order-po; docs/prd/user-flows.md#55-purchase-order-po]

## Tasks / Subtasks
- [x] Task 1 (AC: 1) — Implement PR approver overview card
  - [x] Subtask 1.1: Compose header section with project, supplier, PR number, dual-currency totals, and MR/RFQ traceability chips. [Source: docs/front-end.md#34-purchase-requisition-pr]
  - [x] Subtask 1.2: Ensure responsive card layout aligns with global shell spacing and brand tokens. [Source: docs/front-end.md#2-global-layout]
- [x] Task 2 (AC: 2) — Build approval matrix visualization
  - [x] Subtask 2.1: Map workflow threshold configuration into rows showing role, amount limit, and completion state. [Source: docs/architecture/workflow-handling.md#workflow-handling]
  - [x] Subtask 2.2: Add indicators for current approver, pending steps, and completed approvals with timestamp badges. [Source: docs/uiux/ui-audit-report.md#24-purchase-requisition-pr]
- [x] Task 3 (AC: 3) — Wire approval actions and audit logging
  - [x] Subtask 3.1: Integrate Approve/Reject/Comment actions with workflow engine APIs, enforcing mandatory completion before progression. [Source: docs/architecture/workflow-handling.md#workflow-handling]
  - [x] Subtask 3.2: Persist comments and decision metadata to audit logs and surface history within the view. [Source: docs/architecture/cross-cutting-concerns.md#cross-cutting-concerns]
- [x] Task 4 (AC: 4) — Deliver PO status timeline widget
  - [x] Subtask 4.1: Create timeline component covering Draft → Approved → Sent → Acknowledged with state-specific styling. [Source: docs/front-end.md#35-purchase-order-po]
  - [x] Subtask 4.2: Bind timeline to workflow status events and expose PDF dispatch/acknowledgement actions. [Source: docs/prd/user-flows.md#55-purchase-order-po]
- [x] Task 5 — Testing & validation
  - [x] Subtask 5.1: Add component tests for approval matrix, action handlers, and timeline state transitions. [Source: docs/architecture/high-level-architecture-layers.md#11-frontend-ui-layer]
  - [x] Subtask 5.2: Cover workflow API integration paths (success, rejection, audit logging) with integration or contract tests. [Source: docs/architecture/workflow-handling.md#workflow-handling]

## Dev Notes

### Previous Story Insights
- Quote approval now persists per-line decisions and blocks PR generation until approvals complete; reuse the workflow engine statuses exposed there to populate PR view readiness. [Source: docs/stories/3.4.quote-approval.story.md#tasks--subtasks]
- Quote approval implementation updated audit logging for line-level awards; extend the same audit log patterns when recording PR/PO decisions to keep traceability consistent. [Source: docs/stories/3.4.quote-approval.story.md#dev-notes]

### Data Models
- PR and PO data rely on `prs`, `pr_lines`, `pos`, `po_lines`, and shared `approvals` plus `audit_logs` tables; use existing relationships to fetch approval states and history. [Source: docs/architecture/data-model-highlights.md#data-model-highlights]

### API Specifications
- Workflow engine orchestrates MR → RFQ → PR → PO transitions and enforces mandatory approval gates; approval actions must call its APIs to advance states. [Source: docs/architecture/workflow-handling.md#workflow-handling]
- Audit logging is centralized; any approval action must submit actor, action, and before/after payloads to the immutable audit log pipeline. [Source: docs/architecture/cross-cutting-concerns.md#cross-cutting-concerns]

### Component Specifications
- PR detail view requires card layout with approval buttons, approval matrix, and audit trail tab per design brief. [Source: docs/front-end.md#34-purchase-requisition-pr]
- PO view must include status timeline and dispatch actions styled with Deep Blue header treatments. [Source: docs/front-end.md#35-purchase-order-po]
- Traceability chips should link MR ↔ RFQ ↔ PR ↔ PO states. [Source: docs/front-end.md#4-cross-cutting-ux-elements]

### File Locations
- Existing components noted in UI audit (`PRDashboard.tsx`, `PRDetailView.tsx`, `PRApprovalForm.tsx`, `PODetailView.tsx`) should be extended rather than replaced to keep module organization intact. [Source: docs/uiux/ui-audit-report.md#24-purchase-requisition-pr]
- Place new shared approval widgets (matrix, timeline) under `src/components/approvals/` if consistent with current source tree; adjust once unified structure guidance becomes available. [Source: docs/uiux/ui-audit-report.md#4-prioritized-gap-checklist]

### Testing Requirements
- No specific testing standards located in architecture documentation; follow existing frontend testing practices (React Testing Library + Jest) and ensure coverage for approval flows. [Source: docs/architecture/high-level-architecture-layers.md#11-frontend-ui-layer]

### Technical Constraints
- Frontend remains React SPA using Tailwind + Headless UI with responsive behaviour and PWA support; approval views must respect role-based access. [Source: docs/architecture/high-level-architecture-layers.md#11-frontend-ui-layer]
- Approval routing adheres to role-based authorization with project thresholds; ensure UI reflects RBAC/ABAC rules. [Source: docs/architecture/high-level-architecture-layers.md#15-authentication--authorization]
- Audit logging and notification pipelines rely on centralized services; avoid duplicating logic in frontend and trigger through backend endpoints. [Source: docs/architecture/cross-cutting-concerns.md#cross-cutting-concerns]

### Project Structure Notes
- Unified project structure guidance is not present; align updates with existing PR/PO component locations identified in the UI audit to minimize refactor risk. [Source: docs/uiux/ui-audit-report.md#24-purchase-requisition-pr]

## Testing

### Test File Location
- Co-locate tests under `src/__tests__/components/` alongside approval matrix and timeline components; mirror existing dashboard test organization. [Source: docs/uiux/ui-audit-report.md#24-purchase-requisition-pr]

### Test Standards
- No dedicated testing strategy documented; ensure Jest + React Testing Library coverage for interaction flows and workflow integration mocks. [Source: docs/architecture/high-level-architecture-layers.md#11-frontend-ui-layer]

### Testing Frameworks and Patterns
- Use React Testing Library with user-event to cover approval decisions, comment capture, and timeline state updates. [Source: docs/architecture/high-level-architecture-layers.md#11-frontend-ui-layer]

### Specific Testing Requirements
- Validate approval matrix renders correct pending/current/completed states per workflow data and denies progression when steps missing. [Source: docs/architecture/workflow-handling.md#workflow-handling]
- Confirm PO timeline updates when workflow status changes and dispatch actions trigger corresponding handlers. [Source: docs/front-end.md#35-purchase-order-po]

## Change Log
| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-09-22 | 0.1     | Initial draft for PR/PO approval UX | Bob    |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
