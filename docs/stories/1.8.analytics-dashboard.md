# Story 1.8: Analytics Dashboard

## Status
approved

## Story
**As a** Procurement Manager,
**I want** to view comprehensive analytics and KPIs about procurement performance,
**so that** I can track spending patterns, supplier performance, and make data-driven procurement decisions.

## Acceptance Criteria

1. **Dashboard Overview**: System must display key procurement metrics in a centralized dashboard
2. **PR Analytics**: System must show PRs per month with trends and filtering capabilities
3. **PO Value Tracking**: System must display PO value per month with spending analysis
4. **RFQ Performance**: System must track RFQ response rates and supplier engagement metrics
5. **Supplier Analytics**: System must show supplier share of spend and performance rankings
6. **Item Price Trends**: System must display price trend analysis for items over time
7. **Export Functionality**: System must support CSV export for offline analysis
8. **Role-Based Access**: Analytics must be accessible based on user roles and permissions
9. **Real-Time Data**: Dashboard must show current data with appropriate refresh capabilities
10. **Interactive Charts**: System must provide interactive charts and visualizations for data exploration

## Tasks / Subtasks

- [ ] **Task 1: Data Model and API Development (AC: 1, 2, 3, 4, 5, 6)**
  - [ ] Create analytics data aggregation endpoints
  - [ ] Implement KPI calculation services
  - [ ] Create database views for performance optimization
  - [ ] Develop API endpoints for dashboard data
  - [ ] Implement caching for frequently accessed metrics

- [ ] **Task 2: Frontend Dashboard Components (AC: 1, 7, 8, 9, 10)**
  - [ ] Create main Analytics Dashboard component
  - [ ] Implement KPI cards and summary widgets
  - [ ] Create interactive charts using Recharts/D3
  - [ ] Add filtering and date range selection
  - [ ] Implement CSV export functionality

- [ ] **Task 3: Specific Analytics Modules (AC: 2, 3, 4, 5, 6)**
  - [ ] Create PR Analytics component with monthly trends
  - [ ] Create PO Value Analytics with spending breakdowns
  - [ ] Create RFQ Performance Analytics with response rates
  - [ ] Create Supplier Analytics with share of spend
  - [ ] Create Item Price Trends visualization

- [ ] **Task 4: Integration and Navigation (AC: 8, 9)**
  - [ ] Add Analytics section to main navigation
  - [ ] Implement role-based access control for analytics
  - [ ] Add real-time data refresh capabilities
  - [ ] Integrate with existing procurement workflows

- [ ] **Task 5: Testing and Validation (AC: All)**
  - [ ] Create unit tests for analytics API endpoints
  - [ ] Create component tests for dashboard components
  - [ ] Create integration tests for data aggregation
  - [ ] Validate data accuracy and performance
  - [ ] Test export functionality and role permissions

## Dev Notes

### Previous Story Insights
- **Item Database Management (Story 1.7)**: Established comprehensive item master with historical pricing data
- **Supplier Management (Story 1.6)**: Created supplier performance metrics and historical data
- **Purchase Order Generation (Story 1.5)**: Established PO data structure for value tracking
- **Purchase Requisition Generation (Story 1.4)**: Created PR data for requisition analytics
- **Quote Approval (Story 1.3)**: Established quote data for RFQ performance metrics

### Data Models
**Analytics Data Aggregation:**
```sql
-- KPI Summary View
CREATE VIEW kpi_summary AS
SELECT 
  DATE_TRUNC('month', created_at) as month,
  COUNT(*) as prs_per_month,
  SUM(total_value) as po_value_per_month,
  AVG(response_rate) as avg_rfq_response_rate
FROM procurement_data
GROUP BY DATE_TRUNC('month', created_at);

-- Supplier Performance View
CREATE VIEW supplier_analytics AS
SELECT 
  s.id,
  s.name,
  COUNT(po.id) as total_pos,
  SUM(po.total_value) as total_spend,
  AVG(po.response_time_hours) as avg_response_time
FROM suppliers s
LEFT JOIN purchase_orders po ON s.id = po.supplier_id
GROUP BY s.id, s.name;
```

### API Specifications
**Analytics Endpoints:**
- `GET /api/analytics/dashboard` - Main dashboard data
- `GET /api/analytics/prs` - PR analytics with trends
- `GET /api/analytics/pos` - PO value analytics
- `GET /api/analytics/rfqs` - RFQ performance metrics
- `GET /api/analytics/suppliers` - Supplier analytics
- `GET /api/analytics/items/price-trends` - Item price trends
- `GET /api/analytics/export` - CSV export functionality

### Component Specifications
**AnalyticsDashboard:**
- Props: `{ userRole: string, dateRange: { start: Date, end: Date } }`
- Features: KPI cards, interactive charts, filtering, export
- State: Dashboard data, loading states, selected metrics

**KPICard:**
- Props: `{ title: string, value: string | number, trend: 'up' | 'down' | 'neutral', change: number }`
- Features: Trend indicators, value formatting, click interactions

**AnalyticsChart:**
- Props: `{ data: any[], type: 'line' | 'bar' | 'pie', config: ChartConfig }`
- Features: Interactive tooltips, zoom, filtering, responsive design

### File Locations
**API Routes:**
- `src/app/api/analytics/dashboard/route.ts` - Main dashboard API
- `src/app/api/analytics/prs/route.ts` - PR analytics API
- `src/app/api/analytics/pos/route.ts` - PO analytics API
- `src/app/api/analytics/rfqs/route.ts` - RFQ analytics API
- `src/app/api/analytics/suppliers/route.ts` - Supplier analytics API
- `src/app/api/analytics/items/price-trends/route.ts` - Price trends API
- `src/app/api/analytics/export/route.ts` - Export API

**Components:**
- `src/components/AnalyticsDashboard.tsx` - Main dashboard
- `src/components/KPICard.tsx` - KPI display cards
- `src/components/AnalyticsChart.tsx` - Chart component
- `src/components/PRAnalytics.tsx` - PR-specific analytics
- `src/components/POAnalytics.tsx` - PO-specific analytics
- `src/components/RFQAnalytics.tsx` - RFQ-specific analytics
- `src/components/SupplierAnalytics.tsx` - Supplier-specific analytics
- `src/components/ItemPriceTrends.tsx` - Price trends visualization

**Types:**
- `src/types/analytics.ts` - Analytics interfaces and types

### Testing Requirements
**Unit Tests:**
- Test analytics API endpoints with various date ranges
- Test KPI calculation accuracy
- Test chart component rendering and interactions
- Test export functionality with different data sets

**Integration Tests:**
- Test complete analytics workflow
- Test role-based access to different analytics
- Test data aggregation performance
- Test real-time data refresh

**E2E Tests:**
- Test complete analytics dashboard user journey
- Test filtering and date range selection
- Test CSV export functionality
- Test role-based analytics access

### Technical Constraints
- **Performance**: Implement efficient data aggregation with database views
- **Caching**: Use appropriate caching strategies for frequently accessed metrics
- **Security**: Ensure role-based access to sensitive financial data
- **Scalability**: Design for future OLAP warehouse integration
- **Export**: Support large dataset exports without performance impact

## Testing

### Test File Location
- Unit tests: `src/__tests__/components/Analytics*.test.tsx`
- API tests: `src/__tests__/api/analytics.test.ts`
- Integration tests: `src/__tests__/integration/analytics-workflow.test.ts`
- E2E tests: `src/__tests__/e2e/analytics-dashboard.test.ts`

### Test Standards
- Use Jest and React Testing Library for component tests
- Use Supertest for API testing
- Use Playwright for E2E testing
- Maintain 80%+ code coverage
- Test both happy path and error scenarios

### Testing Frameworks and Patterns
- **Component Testing**: React Testing Library with user-centric testing approach
- **API Testing**: Supertest with comprehensive request/response validation
- **E2E Testing**: Playwright with realistic user workflows
- **Mocking**: Mock external dependencies and API calls

### Specific Testing Requirements
- Test analytics data accuracy against known datasets
- Test chart interactions and responsiveness
- Test export functionality with various data sizes
- Test role-based access to different analytics modules
- Test performance with large datasets

## Change Log
| Date       | Version | Description          | Author       |
|------------|---------|----------------------|--------------|
| 2025-01-21 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
